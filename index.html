document.addEventListener('DOMContentLoaded', function() {
  // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  const MONTH_NAMES = [
    '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', 
    '–ú–∞–π', '–ò—é–Ω—å', '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', 
    '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
  ];
  
  const CATEGORY_COLORS = [
    '#e74c3c', '#3498db', '#2ecc71', '#f39c12', 
    '#9b59b6', '#1abc9c', '#d35400', '#34495e',
    '#16a085', '#27ae60', '#2980b9', '#8e44ad',
    '#f1c40f', '#e67e22', '#c0392b'
  ];

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  const state = {
    currentMonth: new Date().getMonth(),
    currentYear: new Date().getFullYear(),
    financeData: JSON.parse(localStorage.getItem('financeData')) || {},
    budgetData: JSON.parse(localStorage.getItem('budgetData')) || {
      totalAmount: 0,
      days: 0,
      startDate: null,
      spent: 0,
      dailyHistory: {}
    },
    savingsData: JSON.parse(localStorage.getItem('savingsData')) || {
      enabled: false,
      name: '',
      goal: 0,
      current: 0
    },
    fundData: JSON.parse(localStorage.getItem('fundData')) || {
      enabled: false,
      name: '',
      total: 0,
      current: 0
    },
    achievementsData: JSON.parse(localStorage.getItem('achievementsData')) || {
      // ... (–≤—Å–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
    },
    charts: {
      main: null,
      capital: null,
      yearIncome: null,
      yearExpense: null,
      yearCapital: null,
      miniCapital: null,
      miniExpense: null,
      trends: {}
    }
  };

  // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
  const elements = {
    // –û—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    incomeInput: document.getElementById('income-input'),
    incomeDisplay: document.getElementById('income'),
    expenseDisplay: document.getElementById('expense'),
    percentDisplay: document.getElementById('percent'),
    capitalDisplay: document.getElementById('capital-display'),
    widgetsContainer: document.getElementById('widgets'),
    addIncomeBtn: document.getElementById('add-income-btn'),
    
    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
    categoryBtn: document.getElementById('category-btn'),
    categoryMenu: document.getElementById('category-menu'),
    categoriesList: document.getElementById('categories-list'),
    newCategoryInput: document.getElementById('new-category-input'),
    addCategoryBtn: document.getElementById('add-category-btn'),
    closeCategoryWidget: document.getElementById('close-category-widget'),
    
    // –ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è
    capitalizationBtn: document.getElementById('capitalization-btn'),
    capitalizationMenu: document.getElementById('capitalization-menu'),
    capitalInput: document.getElementById('capital-input'),
    saveCapitalBtn: document.getElementById('save-capital-btn'),
    cancelCapitalBtn: document.getElementById('cancel-capital-btn'),
    
    // –û—Ç—á–µ—Ç—ã
    settingsBtn: document.getElementById('settings-btn'),
    settingsMenu: document.getElementById('settings-menu'),
    closeReportsBtn: document.getElementById('close-reports-btn'),
    
    // –ú–µ—Å—è—Ü—ã –∏ –≥–æ–¥—ã
    monthTabs: document.querySelectorAll('.month-tab'),
    yearSummary: document.getElementById('year-summary'),
    closeYearSummary: document.getElementById('close-year-summary'),
    currentYearDisplay: document.getElementById('current-year-display'),
    
    // –ë—é–¥–∂–µ—Ç
    dailyBudgetAmount: document.getElementById('daily-budget-amount'),
    budgetProgress: document.getElementById('budget-progress'),
    budgetSettingsBtn: document.getElementById('budget-settings-btn'),
    setBudgetModal: document.getElementById('set-budget-modal'),
    budgetAmount: document.getElementById('budget-amount'),
    budgetDays: document.getElementById('budget-days'),
    saveBudgetBtn: document.getElementById('save-budget-btn'),
    cancelBudgetBtn: document.getElementById('cancel-budget-btn'),
    
    // –ú–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–∏
    miniCapitalChart: document.getElementById('miniCapitalChart'),
    miniExpenseChart: document.getElementById('miniExpenseChart'),
    
    // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏
    avgIncome: document.getElementById('avg-income'),
    avgExpense: document.getElementById('avg-expense'),
    bestMonth: document.getElementById('best-month'),
    totalIncome: document.getElementById('total-income'),
    totalExpense: document.getElementById('total-expense'),
    
    // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –æ—Ç—á–µ—Ç–æ–≤
    topCategoriesList: document.getElementById('top-categories-list'),
    
    // –¢–µ–º–∞
    themeToggleBtn: document.getElementById('theme-toggle-btn'),
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –º–µ–Ω—é
    moreBtn: document.getElementById('more-btn'),
    moreMenu: document.getElementById('more-menu'),
    
    // –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è
    enableSavingsBtn: document.getElementById('enable-savings-btn'),
    savingsModal: document.getElementById('savings-modal'),
    savingsName: document.getElementById('savings-name'),
    savingsGoal: document.getElementById('savings-goal'),
    saveSavingsBtn: document.getElementById('save-savings-btn'),
    cancelSavingsBtn: document.getElementById('cancel-savings-btn'),
    
    // –§–æ–Ω–¥
    enableFundBtn: document.getElementById('enable-fund-btn'),
    fundModal: document.getElementById('fund-modal'),
    fundName: document.getElementById('fund-name'),
    fundTotal: document.getElementById('fund-total'),
    saveFundBtn: document.getElementById('save-fund-btn'),
    cancelFundBtn: document.getElementById('cancel-fund-btn'),
    
    // –ì–æ–¥ –∏ –∏—Å—Ç–æ—Ä–∏—è
    yearSelectBtn: document.getElementById('year-select-btn'),
    yearSelectModal: document.getElementById('year-select-modal'),
    yearsList: document.getElementById('years-list'),
    addYearBtn: document.getElementById('add-year-btn'),
    closeYearSelect: document.getElementById('close-year-select'),
    historyBtn: document.getElementById('history-btn'),
    historyModal: document.getElementById('history-modal'),
    historyList: document.getElementById('history-list'),
    closeHistory: document.getElementById('close-history'),
    
    // –¢—Ä–µ–Ω–¥—ã
    trendsScroll: document.getElementById('trends-scroll'),
    
    // –û–±—É—á–µ–Ω–∏–µ
    tutorialOverlay: document.getElementById('tutorial-overlay'),
    tutorialBox: document.getElementById('tutorial-box'),
    tutorialTitle: document.getElementById('tutorial-title'),
    tutorialText: document.getElementById('tutorial-text'),
    tutorialPrev: document.getElementById('tutorial-prev'),
    tutorialNext: document.getElementById('tutorial-next'),
    tutorialClose: document.getElementById('tutorial-close'),
    
    // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    achievementsModal: document.getElementById('achievements-modal'),
    achievementsList: document.getElementById('achievements-list'),
    closeAchievements: document.getElementById('close-achievements')
  };

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  const utils = {
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–∞–ª—é—Ç—ã
    formatCurrency: (amount) => {
      return amount.toLocaleString('ru-RU') + ' ‚ÇΩ';
    },
    
    // –ü–∞—Ä—Å–∏–Ω–≥ —á–∏—Å–ª–æ–≤–æ–≥–æ –≤–≤–æ–¥–∞
    parseInputValue: (value) => {
      return parseFloat(value.replace(/\s+/g, '').replace(',', '.'));
    },
    
    // –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ —Ü–≤–µ—Ç–∞
    shadeColor: (color, percent) => {
      let R = parseInt(color.substring(1,3), 16);
      let G = parseInt(color.substring(3,5), 16);
      let B = parseInt(color.substring(5,7), 16);

      R = parseInt(R * (100 + percent) / 100);
      G = parseInt(G * (100 + percent) / 100);
      B = parseInt(B * (100 + percent) / 100);

      R = (R<255)?R:255;  
      G = (G<255)?G:255;  
      B = (B<255)?B:255;  

      const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16);
      const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16);
      const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16);

      return "#"+RR+GG+BB;
    },
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
    showSuccessMessage: (message) => {
      const successMsg = document.createElement('div');
      successMsg.className = 'success-message';
      successMsg.textContent = message;
      document.body.appendChild(successMsg);
      
      setTimeout(() => {
        document.body.removeChild(successMsg);
      }, 3000);
    },
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ
    showAchievementUnlocked: (title) => {
      const msg = document.createElement('div');
      msg.className = 'achievement-unlocked';
      msg.innerHTML = `
        <div class="medal-icon">üèÜ</div>
        <div>
          <strong>–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ!</strong>
          <div>${title}</div>
        </div>
      `;
      document.body.appendChild(msg);
      
      setTimeout(() => {
        msg.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        msg.classList.remove('show');
        setTimeout(() => document.body.removeChild(msg), 500);
      }, 3000);
    },
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–Ω—é
    toggleMenu: (menuElement) => {
      document.querySelectorAll('.neumorphic-menu').forEach(menu => {
        if (menu !== menuElement) menu.classList.remove('show');
      });
      
      menuElement.classList.toggle('show');
      
      if (menuElement.classList.contains('show')) {
        menuElement.style.top = '50%';
        menuElement.style.left = '50%';
        menuElement.style.transform = 'translate(-50%, -50%)';
      }
    },
    
    // –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä–µ—Å–∞–π–∑–∞
    debounce: (func, wait) => {
      let timeout;
      return function() {
        const context = this, args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
          func.apply(context, args);
        }, wait);
      };
    }
  };

  // –†–∞–±–æ—Ç–∞ —Å –¥–∞–Ω–Ω—ã–º–∏
  const dataService = {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –≥–æ–¥–∞
    initYearData: (year) => {
      if (!state.financeData[year]) {
        state.financeData[year] = {};
        for (let i = 0; i < 12; i++) {
          state.financeData[year][i] = { 
            income: 0, 
            expense: 0, 
            categories: {},
            capital: 0,
            expensesHistory: []
          };
        }
      }
    },
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
    saveAllData: () => {
      localStorage.setItem('financeData', JSON.stringify(state.financeData));
      localStorage.setItem('budgetData', JSON.stringify(state.budgetData));
      localStorage.setItem('savingsData', JSON.stringify(state.savingsData));
      localStorage.setItem('fundData', JSON.stringify(state.fundData));
      localStorage.setItem('achievementsData', JSON.stringify(state.achievementsData));
    },
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
    getCurrentMonthData: () => {
      return state.financeData[state.currentYear][state.currentMonth];
    },
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞
    addIncome: (amount) => {
      const monthData = dataService.getCurrentMonthData();
      monthData.income += amount;
      dataService.saveAllData();
    },
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞
    addExpense: (category, amount) => {
      const monthData = dataService.getCurrentMonthData();
      monthData.expense += amount;
      
      if (!monthData.categories[category]) {
        monthData.categories[category] = 0;
      }
      monthData.categories[category] += amount;
      
      // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
      monthData.expensesHistory.push({
        category: category,
        amount: amount,
        date: new Date().toLocaleString()
      });
      
      dataService.saveAllData();
    },
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    deleteCategory: (category) => {
      const monthData = dataService.getCurrentMonthData();
      const categoryExpense = monthData.categories[category] || 0;
      
      monthData.expense -= categoryExpense;
      delete monthData.categories[category];
      
      dataService.saveAllData();
    },
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
    setCapitalization: (amount) => {
      const monthData = dataService.getCurrentMonthData();
      monthData.capital = amount;
      dataService.saveAllData();
    }
  };

  // –†–∞–±–æ—Ç–∞ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏
  const chartService = {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    getChartOptions: (title) => {
      const isMobile = window.innerWidth < 768;
      return {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            display: false,
            labels: {
              font: {
                size: isMobile ? 10 : 12
              }
            }
          },
          tooltip: {
            bodyFont: {
              size: isMobile ? 12 : 14
            },
            callbacks: {
              label: function(context) {
                return `${context.parsed.y.toLocaleString('ru-RU')} ‚ÇΩ`;
              }
            }
          },
          title: {
            display: !!title,
            text: title,
            font: {
              size: isMobile ? 14 : 16
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return (value / 1000).toFixed(value >= 10000 ? 0 : 1) + 'k ‚ÇΩ';
              },
              color: document.body.classList.contains('dark') ? '#eee' : '#333',
              font: {
                size: isMobile ? 10 : 12
              }
            },
            grid: {
              color: document.body.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)'
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              color: document.body.classList.contains('dark') ? '#eee' : '#333',
              font: {
                size: isMobile ? 10 : 12
              }
            }
          }
        },
        animation: {
          duration: 1000,
          easing: 'easeOutQuart'
        },
        devicePixelRatio: 2,
        elements: {
          bar: {
            borderRadius: 6,
            borderWidth: 0
          },
          line: {
            tension: 0.3,
            borderWidth: 3
          },
          point: {
            radius: 4,
            hoverRadius: 6
          }
        }
      };
    },
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤
    renderMainChart: () => {
      const ctx = document.getElementById('barChart')?.getContext('2d');
      if (!ctx) return;
      
      const monthData = dataService.getCurrentMonthData();
      const categoryNames = Object.keys(monthData.categories);
      const values = Object.values(monthData.categories);

      const backgroundColors = categoryNames.map((_, index) => {
        const color = CATEGORY_COLORS[index % CATEGORY_COLORS.length];
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, color);
        gradient.addColorStop(1, utils.shadeColor(color, -40));
        return gradient;
      });

      if (state.charts.main) {
        state.charts.main.data.labels = categoryNames;
        state.charts.main.data.datasets[0].data = values;
        state.charts.main.data.datasets[0].backgroundColor = backgroundColors;
        state.charts.main.update();
      } else {
        state.charts.main = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: categoryNames,
            datasets: [{
              label: '–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º',
              data: values,
              backgroundColor: backgroundColors,
              borderColor: document.body.classList.contains('dark') ? '#2e2e2e' : '#e0e5ec',
              borderWidth: 2,
              borderRadius: 10,
              borderSkipped: false,
            }]
          },
          options: chartService.getChartOptions('–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º')
        });
      }
    },
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
    renderCapitalChart: () => {
      const ctx = document.getElementById('capitalChart')?.getContext('2d');
      if (!ctx) return;
      
      const monthData = dataService.getCurrentMonthData();
      const capitalValue = monthData.capital || 0;

      if (state.charts.capital) {
        state.charts.capital.data.datasets[0].data = [capitalValue];
        state.charts.capital.update();
      } else {
        state.charts.capital = new Chart(ctx, {
          type: 'line',
          data: {
            labels: ['–ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è'],
            datasets: [{
              label: '–ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è',
              data: [capitalValue],
              backgroundColor: '#3498db33',
              borderColor: '#3498db',
              borderWidth: 3,
              tension: 0.3,
              fill: true,
              pointBackgroundColor: '#3498db',
              pointRadius: 5,
              pointHoverRadius: 7
            }]
          },
          options: chartService.getChartOptions('–ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è')
        });
      }
    },
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –º–∏–Ω–∏-–≥—Ä–∞—Ñ–∏–∫–æ–≤
    renderMiniCharts: () => {
      const labels = MONTH_NAMES.map(name => name.substring(0, 3));
      const capitalData = [];
      const expenseData = [];
      
      for (let i = 0; i < 12; i++) {
        const monthData = state.financeData[state.currentYear][i] || { income: 0, expense: 0, capital: 0 };
        capitalData.push(monthData.capital);
        expenseData.push(monthData.expense);
      }
      
      // –ì—Ä–∞—Ñ–∏–∫ –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
      const capitalCtx = elements.miniCapitalChart?.getContext('2d');
      if (capitalCtx) {
        if (state.charts.miniCapital) {
          state.charts.miniCapital.data.datasets[0].data = capitalData;
          state.charts.miniCapital.update();
        } else {
          state.charts.miniCapital = new Chart(capitalCtx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                data: capitalData,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                fill: true
              }]
            },
            options: chartService.getChartOptions('–ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è')
          });
        }
      }
      
      // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤
      const expenseCtx = elements.miniExpenseChart?.getContext('2d');
      if (expenseCtx) {
        if (state.charts.miniExpense) {
          state.charts.miniExpense.data.datasets[0].data = expenseData;
          state.charts.miniExpense.update();
        } else {
          state.charts.miniExpense = new Chart(expenseCtx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                data: expenseData,
                backgroundColor: 'rgba(231, 76, 60, 0.7)',
                borderColor: 'rgba(231, 76, 60, 1)',
                borderWidth: 2,
                borderRadius: 5,
                borderSkipped: false,
              }]
            },
            options: chartService.getChartOptions('–†–∞—Å—Ö–æ–¥—ã')
          });
        }
      }
    },
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥–æ–¥–æ–≤—ã—Ö –≥—Ä–∞—Ñ–∏–∫–æ–≤
    renderYearCharts: () => {
      const labels = MONTH_NAMES;
      const incomeData = [];
      const expenseData = [];
      const capitalData = [];
      
      for (let i = 0; i < 12; i++) {
        const monthData = state.financeData[state.currentYear][i] || { income: 0, expense: 0, capital: 0 };
        incomeData.push(monthData.income);
        expenseData.push(monthData.expense);
        capitalData.push(monthData.capital);
      }
      
      // –ì—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–æ–≤
      const incomeCtx = document.getElementById('yearIncomeChart')?.getContext('2d');
      if (incomeCtx) {
        if (state.charts.yearIncome) {
          state.charts.yearIncome.data.datasets[0].data = incomeData;
          state.charts.yearIncome.update();
        } else {
          state.charts.yearIncome = new Chart(incomeCtx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: '–î–æ—Ö–æ–¥',
                data: incomeData,
                backgroundColor: 'rgba(46, 204, 113, 0.7)',
                borderColor: 'rgba(46, 204, 113, 1)',
                borderWidth: 2,
                borderRadius: 5,
                borderSkipped: false,
              }]
            },
            options: chartService.getChartOptions('–î–æ—Ö–æ–¥ –ø–æ –º–µ—Å—è—Ü–∞–º')
          });
        }
      }
      
      // –ì—Ä–∞—Ñ–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤
      const expenseCtx = document.getElementById('yearExpenseChart')?.getContext('2d');
      if (expenseCtx) {
        if (state.charts.yearExpense) {
          state.charts.yearExpense.data.datasets[0].data = expenseData;
          state.charts.yearExpense.update();
        } else {
          state.charts.yearExpense = new Chart(expenseCtx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: '–†–∞—Å—Ö–æ–¥',
                data: expenseData,
                backgroundColor: 'rgba(231, 76, 60, 0.7)',
                borderColor: 'rgba(231, 76, 60, 1)',
                borderWidth: 2,
                borderRadius: 5,
                borderSkipped: false,
              }]
            },
            options: chartService.getChartOptions('–†–∞—Å—Ö–æ–¥ –ø–æ –º–µ—Å—è—Ü–∞–º')
          });
        }
      }
      
      // –ì—Ä–∞—Ñ–∏–∫ –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏
      const capitalCtx = document.getElementById('yearCapitalChart')?.getContext('2d');
      if (capitalCtx) {
        if (state.charts.yearCapital) {
          state.charts.yearCapital.data.datasets[0].data = capitalData;
          state.charts.yearCapital.update();
        } else {
          state.charts.yearCapital = new Chart(capitalCtx, {
            type: 'line',
            data: {
              labels: labels,
              datasets: [{
                label: '–ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è',
                data: capitalData,
                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                borderColor: 'rgba(52, 152, 219, 1)',
                borderWidth: 3,
                tension: 0.3,
                fill: true,
                pointBackgroundColor: 'rgba(52, 152, 219, 1)',
                pointRadius: 5,
                pointHoverRadius: 7
              }]
            },
            options: chartService.getChartOptions('–ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º')
          });
        }
      }
    },
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –¥–∏–Ω–∞–º–∏–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    renderCategoryTrends: () => {
      elements.trendsScroll.innerHTML = '';
      
      const monthData = dataService.getCurrentMonthData();
      const categories = Object.keys(monthData.categories);
      
      categories.forEach(category => {
        const trendData = [];
        
        // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∑–∞ –≤—Å–µ –º–µ—Å—è—Ü—ã –≥–æ–¥–∞
        for (let i = 0; i < 12; i++) {
          const monthCatData = state.financeData[state.currentYear][i].categories || {};
          trendData.push(monthCatData[category] || 0);
        }
        
        const container = document.createElement('div');
        container.className = 'trend-chart-container';
        container.innerHTML = `<h4>${category}</h4><canvas id="trend-${category}"></canvas>`;
        elements.trendsScroll.appendChild(container);
        
        const ctx = document.getElementById(`trend-${category}`).getContext('2d');
        const color = CATEGORY_COLORS[categories.indexOf(category) % CATEGORY_COLORS.length];
        
        if (state.charts.trends[category]) {
          state.charts.trends[category].destroy();
        }
        
        state.charts.trends[category] = new Chart(ctx, {
          type: 'line',
          data: {
            labels: MONTH_NAMES.map(name => name.substring(0, 3)),
            datasets: [{
              label: category,
              data: trendData,
              borderColor: color,
              backgroundColor: `${color}33`,
              borderWidth: 2,
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            ...chartService.getChartOptions(category),
            aspectRatio: 1,
            maintainAspectRatio: true
          }
        });
      });
    }
  };

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
  const uiService = {
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    updateUI: () => {
      const monthData = dataService.getCurrentMonthData();
      const capital = monthData.capital || 0;
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
      elements.incomeDisplay.textContent = utils.formatCurrency(monthData.income);
      elements.expenseDisplay.textContent = utils.formatCurrency(monthData.expense);
      elements.currentYearDisplay.textContent = `–ì–æ–¥: ${state.currentYear}`;
      
      // –†–∞—Å—á–µ—Ç –ø—Ä–æ—Ü–µ–Ω—Ç–∞ –æ—Å—Ç–∞—Ç–∫–∞
      const remaining = monthData.income - monthData.expense;
      const percentage = monthData.income > 0 
          ? Math.round((remaining / monthData.income) * 100)
          : 0;
      
      elements.percentDisplay.textContent = (remaining < 0 ? '-' : '') + Math.abs(percentage) + '%';
      
      if (remaining < 0) {
          elements.percentDisplay.classList.add('negative');
      } else {
          elements.percentDisplay.classList.remove('negative');
          elements.percentDisplay.style.color = percentage < 20 ? '#f39c12' : '#2ecc71';
      }
      
      elements.capitalDisplay.textContent = utils.formatCurrency(capital);
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–æ–≤
      uiService.updateBudgetWidget();
      uiService.updateFinancialMetrics();
      uiService.renderWidgets();
      uiService.renderSavingsWidget();
      uiService.renderFundWidget();
      uiService.renderExpenseHistory();
      
      // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤
      chartService.renderMainChart();
      chartService.renderCapitalChart();
      chartService.renderMiniCharts();
      chartService.renderCategoryTrends();
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
      achievementService.checkAchievements();
    },
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞ –±—é–¥–∂–µ—Ç–∞
    updateBudgetWidget: () => {
      if (!state.budgetData.startDate) {
        elements.dailyBudgetAmount.textContent = utils.formatCurrency(0);
        elements.budgetProgress.textContent = '–ù–µ –∑–∞–¥–∞–Ω–æ';
        if (elements.daysProgressBar) elements.daysProgressBar.style.width = '100%';
        if (elements.fundsProgressBar) elements.fundsProgressBar.style.width = '100%';
        if (elements.daysProgressValue) elements.daysProgressValue.textContent = '100%';
        if (elements.fundsProgressValue) elements.fundsProgressValue.textContent = '100%';
        return;
      }

      const today = new Date();
      const startDate = new Date(state.budgetData.startDate);
      const todayStr = today.toISOString().split('T')[0];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±—é–¥–∂–µ—Ç –≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ
      if (today.getMonth() !== startDate.getMonth() || 
          today.getFullYear() !== startDate.getFullYear()) {
        elements.dailyBudgetAmount.textContent = utils.formatCurrency(0);
        elements.budgetProgress.textContent = '–°—Ä–æ–∫ –∏—Å—Ç–µ–∫';
        if (elements.daysProgressBar) elements.daysProgressBar.style.width = '0%';
        if (elements.fundsProgressBar) elements.fundsProgressBar.style.width = '0%';
        if (elements.daysProgressValue) elements.daysProgressValue.textContent = '0%';
        if (elements.fundsProgressValue) elements.fundsProgressValue.textContent = '0%';
        return;
      }

      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—à–µ–¥—à–∏–µ –¥–Ω–∏ (–≤–∫–ª—é—á–∞—è —Ç–µ–∫—É—â–∏–π)
      const elapsedDays = Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;
      const remainingDays = Math.max(0, state.budgetData.days - elapsedDays + 1);
      
      if (remainingDays <= 0) {
        elements.dailyBudgetAmount.textContent = utils.formatCurrency(0);
        elements.budgetProgress.textContent = '–°—Ä–æ–∫ –∏—Å—Ç–µ–∫';
        if (elements.daysProgressBar) elements.daysProgressBar.style.width = '0%';
        if (elements.fundsProgressBar) elements.fundsProgressBar.style.width = '0%';
        if (elements.daysProgressValue) elements.daysProgressValue.textContent = '0%';
        if (elements.fundsProgressValue) elements.fundsProgressValue.textContent = '0%';
        return;
      }

      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ—Å—Ç–∞—Ç–æ–∫ –±—é–¥–∂–µ—Ç–∞
      let remainingAmount = state.budgetData.totalAmount;
      let totalSpent = 0;
      
      for (let i = 0; i < elapsedDays; i++) {
        const date = new Date(startDate);
        date.setDate(startDate.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        
        if (state.budgetData.dailyHistory[dateStr]) {
          const dailySpent = state.budgetData.dailyHistory[dateStr].spentToday;
          remainingAmount -= dailySpent;
          totalSpent += dailySpent;
        }
      }

      if (remainingAmount <= 0) {
        elements.dailyBudgetAmount.textContent = utils.formatCurrency(0);
        elements.budgetProgress.textContent = '–ë—é–¥–∂–µ—Ç –∏—Å—á–µ—Ä–ø–∞–Ω';
        const daysProgress = 100 - (elapsedDays / state.budgetData.days * 100);
        if (elements.daysProgressBar) elements.daysProgressBar.style.width = `${Math.max(0, daysProgress)}%`;
        if (elements.fundsProgressBar) elements.fundsProgressBar.style.width = '0%';
        if (elements.daysProgressValue) elements.daysProgressValue.textContent = `${Math.round(Math.max(0, daysProgress))}%`;
        if (elements.fundsProgressValue) elements.fundsProgressValue.textContent = '0%';
        return;
      }

      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–Ω–µ–≤–Ω–æ–π –±—é–¥–∂–µ—Ç —Å —É—á–µ—Ç–æ–º –æ—Å—Ç–∞—Ç–∫–∞
      const dailyBudget = remainingAmount / remainingDays;
      
      elements.dailyBudgetAmount.textContent = utils.formatCurrency(dailyBudget);
      elements.budgetProgress.textContent = 
          `–û—Å—Ç–∞—Ç–æ–∫: ${utils.formatCurrency(remainingAmount)} | ${remainingDays} –¥–Ω.`;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã (—Ä–µ–≤–µ—Ä—Å–∏–≤–Ω—ã–µ)
      const daysProgress = 100 - (elapsedDays / state.budgetData.days * 100);
      const fundsProgress = 100 - (totalSpent / state.budgetData.totalAmount * 100);
      
      if (elements.daysProgressBar) elements.daysProgressBar.style.width = `${Math.max(0, daysProgress)}%`;
      if (elements.fundsProgressBar) elements.fundsProgressBar.style.width = `${Math.max(0, fundsProgress)}%`;
      if (elements.daysProgressValue) elements.daysProgressValue.textContent = `${Math.round(Math.max(0, daysProgress))}%`;
      if (elements.fundsProgressValue) elements.fundsProgressValue.textContent = `${Math.round(Math.max(0, fundsProgress))}%`;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ç—Ä–∞—Ç
      if (!state.budgetData.dailyHistory[todayStr]) {
        state.budgetData.dailyHistory[todayStr] = {
          date: todayStr,
          dailyBudget: dailyBudget,
          spentToday: 0
        };
      }
      localStorage.setItem('budgetData', JSON.stringify(state.budgetData));
    },
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π
    updateFinancialMetrics: () => {
      let totalIncome = 0;
      let totalExpense = 0;
      let bestMonthValue = 0;
      let bestMonthName = '';
      let bestMonthIndex = -1;
      
      for (let i = 0; i < 12; i++) {
        const monthData = state.financeData[state.currentYear][i] || { income: 0, expense: 0, capital: 0 };
        totalIncome += monthData.income || 0;
        totalExpense += monthData.expense || 0;
        
        if (monthData.income > bestMonthValue) {
          bestMonthValue = monthData.income;
          bestMonthName = MONTH_NAMES[i];
          bestMonthIndex = i;
        }
      }
      
      elements.avgIncome.textContent = utils.formatCurrency(Math.round(totalIncome / 12));
      elements.avgExpense.textContent = utils.formatCurrency(Math.round(totalExpense / 12));
      elements.totalIncome.textContent = utils.formatCurrency(totalIncome);
      elements.totalExpense.textContent = utils.formatCurrency(totalExpense);
      
      if (bestMonthIndex >= 0) {
        const monthData = state.financeData[state.currentYear][bestMonthIndex];
        const profit = monthData.income - monthData.expense;
        elements.bestMonth.textContent = `${bestMonthName}\n+${utils.formatCurrency(profit)}`;
      } else {
        elements.bestMonth.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
      }
      
      chartService.renderMiniCharts();
      uiService.renderTopCategoriesReport();
    },
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∞–º—ã—Ö –∑–∞—Ç—Ä–∞—Ç–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    renderTopCategoriesReport: () => {
      elements.topCategoriesList.innerHTML = '';
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –º–µ—Å—è—Ü—ã –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ –∫ –ø—Ä–æ—à–ª–æ–º—É
      const sortedMonths = [];
      for (let i = 0; i < 12; i++) {
        const monthIndex = (state.currentMonth - i + 12) % 12;
        sortedMonths.push(monthIndex);
      }

      sortedMonths.forEach(monthIndex => {
        const monthData = state.financeData[state.currentYear][monthIndex] || { categories: {} };
        const categories = Object.entries(monthData.categories);
        
        if (categories.length > 0) {
          // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø–æ —É–±—ã–≤–∞–Ω–∏—é —Ä–∞—Å—Ö–æ–¥–æ–≤
          categories.sort((a, b) => b[1] - a[1]);
          
          const monthElement = document.createElement('div');
          monthElement.className = 'month-categories';
          monthElement.innerHTML = `<h5>${MONTH_NAMES[monthIndex]}</h5>`;
          
          // –ë–µ—Ä–µ–º —Ç–æ–ø-3 –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ –≤—Å–µ, –µ—Å–ª–∏ –∏—Ö –º–µ–Ω—å—à–µ 3
          const topCategories = categories.slice(0, 3);
          
          // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—â—É—é —Å—É–º–º—É —Ä–∞—Å—Ö–æ–¥–æ–≤ –∑–∞ –º–µ—Å—è—Ü
          const totalExpense = categories.reduce((sum, [_, amount]) => sum + amount, 0);
          const totalElement = document.createElement('div');
          totalElement.className = 'category-item total';
          totalElement.innerHTML = `
            <span>–í—Å–µ–≥–æ —Ä–∞—Å—Ö–æ–¥–æ–≤</span>
            <strong>${utils.formatCurrency(totalExpense)}</strong>
          `;
          monthElement.appendChild(totalElement);
          
          topCategories.forEach(([category, amount], index) => {
            const percent = Math.round((amount / totalExpense) * 100);
            const categoryElement = document.createElement('div');
            categoryElement.className = 'category-item';
            categoryElement.innerHTML = `
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="color: ${CATEGORY_COLORS[index % CATEGORY_COLORS.length]}; font-weight: bold;">‚ñ†</span>
                <span>${category}</span>
              </div>
              <div style="text-align: right;">
                <div>${utils.formatCurrency(amount)}</div>
                <small style="color: ${document.body.classList.contains('dark') ? '#aaa' : '#666'}">${percent}%</small>
              </div>
            `;
            monthElement.appendChild(categoryElement);
          });
          
          elements.topCategoriesList.appendChild(monthElement);
        }
      });
    },
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤–∏–¥–∂–µ—Ç–æ–≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    renderWidgets: () => {
      elements.widgetsContainer.innerHTML = '';
      const monthData = dataService.getCurrentMonthData();
      const categories = monthData.categories || {};
      
      Object.entries(categories).forEach(([cat, val], index) => {
        const widget = document.createElement('div');
        widget.className = 'neumorphic-card widget';
        const color = CATEGORY_COLORS[index % CATEGORY_COLORS.length];
        
        widget.style.setProperty('--widget-color', color);
        
        widget.innerHTML = `
          <button class="delete-widget-btn" data-category="${cat}">√ó</button>
          <h3 style="color: ${color}">${cat}</h3>
          <p>${utils.formatCurrency(val)}</p>
          <div class="widget-input-group">
            <input type="number" class="neumorphic-input widget-input" placeholder="–°—É–º–º–∞" id="expense-${cat}">
            <button class="neumorphic-btn small" data-category="${cat}">+</button>
          </div>
        `;
        
        elements.widgetsContainer.appendChild(widget);
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
      document.querySelectorAll('.delete-widget-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const category = this.getAttribute('data-category');
          if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${category}" —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞?`)) {
            dataService.deleteCategory(category);
            uiService.updateUI();
          }
        });
      });

      document.querySelectorAll('.widget-input-group .neumorphic-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const category = this.getAttribute('data-category');
          const input = document.getElementById(`expense-${category}`);
          const expenseVal = utils.parseInputValue(input.value);
          
          if (!isNaN(expenseVal) && expenseVal > 0) {
            dataService.addExpense(category, expenseVal);
            input.value = '';
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –∫–Ω–æ–ø–∫–∏
            const btn = input.nextElementSibling;
            btn.classList.add('pulse');
            setTimeout(() => btn.classList.remove('pulse'), 500);
            
            uiService.updateUI();
          }
        });
      });
    },
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π
    renderSavingsWidget: () => {
      if (!state.savingsData.enabled) return;
      
      const widget = document.createElement('div');
      widget.className = 'neumorphic-card widget savings-widget';
      widget.style.setProperty('--widget-color', '#2ecc71');
      
      const progress = state.savingsData.goal > 0 ? 
        Math.min(100, Math.round((state.savingsData.current / state.savingsData.goal) * 100)) : 0;
      
      widget.innerHTML = `
        <button class="delete-widget-btn" id="disable-savings-btn">√ó</button>
        <h3 style="color: #2ecc71">${state.savingsData.name || '–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è'}</h3>
        <div class="savings-progress-container">
          <div class="savings-progress-bar" style="width: ${progress}%"></div>
        </div>
        <p>${utils.formatCurrency(state.savingsData.current)} / ${utils.formatCurrency(state.savingsData.goal)} (${progress}%)</p>
        <div class="widget-input-group">
          <input type="number" class="neumorphic-input widget-input" placeholder="–°—É–º–º–∞" id="savings-amount">
          <button class="neumorphic-btn small" id="add-to-savings-btn">+</button>
        </div>
      `;
      
      elements.widgetsContainer.prepend(widget);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π
      document.getElementById('disable-savings-btn')?.addEventListener('click', () => {
        if (confirm('–û—Ç–∫–ª—é—á–∏—Ç—å –≤–∏–¥–∂–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π?')) {
          state.savingsData.enabled = false;
          dataService.saveAllData();
          uiService.updateUI();
        }
      });

      document.getElementById('add-to-savings-btn')?.addEventListener('click', () => {
        const input = document.getElementById('savings-amount');
        const amount = utils.parseInputValue(input.value);
        
        if (!isNaN(amount) && amount > 0) {
          state.savingsData.current += amount;
          dataService.saveAllData();
          input.value = '';
          
          const btn = input.nextElementSibling;
          btn.classList.add('pulse');
          setTimeout(() => btn.classList.remove('pulse'), 500);
          
          uiService.updateUI();
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π
          if (state.savingsData.goal > 0 && state.savingsData.current >= state.savingsData.goal && 
              !state.achievementsData.saverGoal.unlocked) {
            state.achievementsData.saverGoal.unlocked = true;
            utils.showAchievementUnlocked(state.achievementsData.saverGoal.title);
            dataService.saveAllData();
          }
        }
      });
    },
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤–∏–¥–∂–µ—Ç–∞ —Ñ–æ–Ω–¥–∞
    renderFundWidget: () => {
      if (!state.fundData.enabled) return;
      
      const widget = document.createElement('div');
      widget.className = 'neumorphic-card widget fund-widget';
      widget.style.setProperty('--widget-color', '#e74c3c');
      
      const progress = state.fundData.total > 0 ? 
        Math.min(100, Math.round((state.fundData.current / state.fundData.total) * 100)) : 0;
      
      widget.innerHTML = `
        <button class="delete-widget-btn" id="disable-fund-btn">√ó</button>
        <h3 style="color: #e74c3c">${state.fundData.name || '–§–æ–Ω–¥'}</h3>
        <div class="savings-progress-container">
          <div class="savings-progress-bar" style="width: ${progress}%"></div>
        </div>
        <p>${utils.formatCurrency(state.fundData.current)} / ${utils.formatCurrency(state.fundData.total)} (${progress}%)</p>
        <div class="widget-input-group">
          <input type="number" class="neumorphic-input widget-input" placeholder="–°—É–º–º–∞ —Ç—Ä–∞—Ç—ã" id="fund-expense">
          <button class="neumorphic-btn small" id="subtract-from-fund-btn">-</button>
        </div>
      `;
      
      elements.widgetsContainer.prepend(widget);

      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤–∏–¥–∂–µ—Ç–∞ —Ñ–æ–Ω–¥–∞
      document.getElementById('disable-fund-btn')?.addEventListener('click', () => {
        if (confirm('–û—Ç–∫–ª—é—á–∏—Ç—å –≤–∏–¥–∂–µ—Ç —Ñ–æ–Ω–¥–∞?')) {
          state.fundData.enabled = false;
          dataService.saveAllData();
          uiService.updateUI();
        }
      });

      document.getElementById('subtract-from-fund-btn')?.addEventListener('click', () => {
        const input = document.getElementById('fund-expense');
        const amount = utils.parseInputValue(input.value);
        
        if (!isNaN(amount) && amount > 0) {
          if (amount > state.fundData.current) {
            alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –≤ —Ñ–æ–Ω–¥–µ!');
            return;
          }
          
          state.fundData.current -= amount;
          dataService.saveAllData();
          input.value = '';
          
          const btn = input.nextElementSibling;
          btn.classList.add('pulse');
          setTimeout(() => btn.classList.remove('pulse'), 500);
          
          uiService.updateUI();
          
          // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è "–§–æ–Ω–¥–æ–≤–∏–∫"
          if (state.fundData.current <= 0 && !state.achievementsData.fundMaster.unlocked) {
            state.achievementsData.fundMaster.unlocked = true;
            utils.showAchievementUnlocked(state.achievementsData.fundMaster.title);
            dataService.saveAllData();
          }
        }
      });
    },
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ç—Ä–∞—Ç
    renderExpenseHistory: () => {
      elements.historyList.innerHTML = '';
      const monthData = dataService.getCurrentMonthData();
      const history = monthData.expensesHistory || [];
      
      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∫ —Å—Ç–∞—Ä—ã–º
      const sortedHistory = [...history].reverse();
      
      sortedHistory.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.innerHTML = `
          <div>${item.category}: ${utils.formatCurrency(item.amount)}</div>
          <div class="history-date">${item.date}</div>
        `;
        elements.historyList.appendChild(historyItem);
      });
    },
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    renderAchievements: () => {
      const container = document.getElementById('achievements-list');
      if (!container) return;
      
      container.innerHTML = '';
      
      Object.entries(state.achievementsData).forEach(([key, achievement]) => {
        const achievementEl = document.createElement('div');
        achievementEl.className = `achievement-widget ${achievement.unlocked ? 'unlocked' : 'locked'}`;
        achievementEl.innerHTML = `
          <div class="medal-icon">${achievement.unlocked ? 'üèÜ' : 'üèÖ'}</div>
          <div class="achievement-content">
            <h4>${achievement.title}</h4>
            <p>${achievement.description}</p>
          </div>
        `;
        container.appendChild(achievementEl);
      });
    },
    
    // –í—ã–±–æ—Ä –≥–æ–¥–∞
    renderYearSelection: () => {
      elements.yearsList.innerHTML = '';
      
      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≥–æ–¥—ã
      const years = Object.keys(state.financeData).sort((a, b) => b - a);
      
      years.forEach(year => {
        const yearBtn = document.createElement('button');
        yearBtn.className = 'year-btn';
        yearBtn.textContent = year;
        yearBtn.addEventListener('click', () => {
          state.currentYear = parseInt(year);
          elements.yearSelectModal.classList.remove('show');
          uiService.updateUI();
        });
        elements.yearsList.appendChild(yearBtn);
      });
    }
  };

  // –†–∞–±–æ—Ç–∞ —Å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è–º–∏
  const achievementService = {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π
    checkAchievements: () => {
      const monthData = dataService.getCurrentMonthData();
      const income = monthData.income || 0;
      const expense = monthData.expense || 0;
      const capital = monthData.capital || 0;
      const categories = monthData.categories || {};
      const now = new Date();
      const hours = now.getHours();
      const dayOfWeek = now.getDay();
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
      if (income > 0 && !state.achievementsData.firstIncome.unlocked) {
        state.achievementsData.firstIncome.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.firstIncome.title);
      }
      
      if (expense > 0 && !state.achievementsData.firstExpense.unlocked) {
        state.achievementsData.firstExpense.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.firstExpense.title);
      }
      
      if (income > 0 && expense/income < 0.5 && !state.achievementsData.saver.unlocked) {
        state.achievementsData.saver.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.saver.title);
      }
      
      if (income > 0 && expense/income < 0.3 && !state.achievementsData.superSaver.unlocked) {
        state.achievementsData.superSaver.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.superSaver.title);
      }
      
      if (income > 50000 && !state.achievementsData.earner.unlocked) {
        state.achievementsData.earner.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.earner.title);
      }
      
      if (income > 100000 && !state.achievementsData.superEarner.unlocked) {
        state.achievementsData.superEarner.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.superEarner.title);
      }
      
      if (capital > 100000 && !state.achievementsData.investor.unlocked) {
        state.achievementsData.investor.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.investor.title);
      }
      
      if (Object.keys(categories).length >= 5 && !state.achievementsData.categoryMaster.unlocked) {
        state.achievementsData.categoryMaster.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.categoryMaster.title);
      }
      
      if (hours < 9 && !state.achievementsData.earlyBird.unlocked) {
        state.achievementsData.earlyBird.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.earlyBird.title);
      }
      
      if (hours >= 23 && !state.achievementsData.nightOwl.unlocked) {
        state.achievementsData.nightOwl.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.nightOwl.title);
      }
      
      if (income === expense && income > 0 && !state.achievementsData.balanced.unlocked) {
        state.achievementsData.balanced.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.balanced.title);
      }
      
      if (expense === 0 && income > 0 && !state.achievementsData.zeroWaste.unlocked) {
        state.achievementsData.zeroWaste.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.zeroWaste.title);
      }
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å
      if ((dayOfWeek === 0 || dayOfWeek === 6) && !state.achievementsData.weekendWarrior.unlocked) {
        state.achievementsData.weekendWarrior.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.weekendWarrior.title);
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –º–µ—Å—è—Ü–µ–≤ –≥–æ–¥–∞
      let allMonthsFilled = true;
      for (let i = 0; i < 12; i++) {
        if (state.financeData[state.currentYear][i].income === 0 && 
            state.financeData[state.currentYear][i].expense === 0) {
          allMonthsFilled = false;
          break;
        }
      }
      
      if (allMonthsFilled && !state.achievementsData.yearComplete.unlocked) {
        state.achievementsData.yearComplete.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.yearComplete.title);
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è "–§–æ–Ω–¥–æ–≤–∏–∫"
      if (state.fundData.enabled && state.fundData.current <= 0 && !state.achievementsData.fundMaster.unlocked) {
        state.achievementsData.fundMaster.unlocked = true;
        utils.showAchievementUnlocked(state.achievementsData.fundMaster.title);
      }
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ)
      // ...

      dataService.saveAllData();
    }
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è
  const initTutorial = () => {
    const tutorialSteps = [
      {
        title: "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞",
        text: "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–æ—Ö–æ–¥–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '+' –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è. –≠—Ç–∞ —Å—É–º–º–∞ –±—É–¥–µ—Ç —É—á—Ç–µ–Ω–∞ –≤ —Ç–µ–∫—É—â–µ–º –º–µ—Å—è—Ü–µ."
      },
      {
        title: "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤",
        text: "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏' –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏. –î–æ–±–∞–≤–ª—è–π—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º —á–µ—Ä–µ–∑ –≤–∏–¥–∂–µ—Ç—ã."
      },
      {
        title: "–ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è",
        text: "–ö–Ω–æ–ø–∫–∞ '–ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è' –ø–æ–∑–≤–æ–ª—è–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –æ–±—â—É—é —Å—É–º–º—É –∞–∫—Ç–∏–≤–æ–≤. –≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ '–ö–∞–ø–∏—Ç–∞–ª'."
      },
      {
        title: "–û—Ç—á—ë—Ç—ã",
        text: "–í —Ä–∞–∑–¥–µ–ª–µ '–û—Ç—á—ë—Ç—ã' –≤—ã –Ω–∞–π–¥–µ—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –≤–∞—à–∏–º —Ñ–∏–Ω–∞–Ω—Å–∞–º: —Å—Ä–µ–¥–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è, –ª—É—á—à–∏–π –º–µ—Å—è—Ü –∏ –≥—Ä–∞—Ñ–∏–∫–∏."
      },
      {
        title: "–î–Ω–µ–≤–Ω–æ–π –±—é–¥–∂–µ—Ç",
        text: "–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±—é–¥–∂–µ—Ç –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π. –°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç –¥–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç –∏ –æ—Ç—Å–ª–µ–¥–∏—Ç –≤–∞—à–∏ —Ç—Ä–∞—Ç—ã."
      },
      {
        title: "–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è",
        text: "–í–∫–ª—é—á–∏—Ç–µ –≤–∏–¥–∂–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π —á–µ—Ä–µ–∑ –º–µ–Ω—é (‚ò∞) –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Ü–µ–ª—å. –û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ –≤–∏–¥–∂–µ—Ç–µ."
      },
      {
        title: "–§–æ–Ω–¥",
        text: "–í–∫–ª—é—á–∏—Ç–µ –≤–∏–¥–∂–µ—Ç —Ñ–æ–Ω–¥–∞ —á–µ—Ä–µ–∑ –º–µ–Ω—é (‚ò∞) –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Å—É–º–º—É —Ñ–æ–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –¥–ª—è –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç—Ä–∞—Ç."
      },
      {
        title: "–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è",
        text: "–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –º–µ–¥–∞–ª–∏ –∑–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∑–∞–¥–∞—á. –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∏—Ö –≤ —Ä–∞–∑–¥–µ–ª–µ '–ù–∞–≥—Ä–∞–¥—ã'."
      },
      {
        title: "–ì—Ä–∞—Ñ–∏–∫–∏",
        text: "–û—Å–Ω–æ–≤–Ω–æ–π –≥—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º. –ù–∏–∂–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ –¥–∏–Ω–∞–º–∏–∫–∞ —Ç—Ä–∞—Ç –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º –∑–∞ –≥–æ–¥."
      }
    ];
    
    let currentStep = 0;
    
    function showTutorialStep(step) {
      elements.tutorialTitle.textContent = tutorialSteps[step].title;
      elements.tutorialText.textContent = tutorialSteps[step].text;
      elements.tutorialOverlay.style.display = 'flex';
    }
    
    elements.tutorialNext.addEventListener('click', () => {
      currentStep++;
      if (currentStep >= tutorialSteps.length) {
        elements.tutorialOverlay.style.display = 'none';
      } else {
        showTutorialStep(currentStep);
      }
    });
    
    elements.tutorialPrev.addEventListener('click', () => {
      if (currentStep > 0) {
        currentStep--;
        showTutorialStep(currentStep);
      }
    });
    
    elements.tutorialClose.addEventListener('click', () => {
      elements.tutorialOverlay.style.display = 'none';
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—É—á–µ–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
    if (!localStorage.getItem('tutorialShown')) {
      showTutorialStep(0);
      localStorage.setItem('tutorialShown', 'true');
    }
  };

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
  const setupEventHandlers = () => {
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞
    elements.addIncomeBtn.addEventListener('click', () => {
      const incomeVal = utils.parseInputValue(elements.incomeInput.value);
      if (!isNaN(incomeVal)) {
        dataService.addIncome(incomeVal);
        elements.incomeInput.value = '';
        
        elements.addIncomeBtn.classList.add('pulse');
        setTimeout(() => elements.addIncomeBtn.classList.remove('pulse'), 500);
        
        uiService.updateUI();
      }
    });

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    elements.addCategoryBtn.addEventListener('click', () => {
      const categoryName = elements.newCategoryInput.value.trim();
      if (categoryName) {
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏—é –≤–æ –≤—Å–µ –º–µ—Å—è—Ü—ã —Ç–µ–∫—É—â–µ–≥–æ –≥–æ–¥–∞
        for (let i = 0; i < 12; i++) {
          const monthData = state.financeData[state.currentYear][i];
          if (!monthData.categories[categoryName]) {
            monthData.categories[categoryName] = 0;
          }
        }
        elements.newCategoryInput.value = '';
        dataService.saveAllData();
        uiService.updateUI();
      }
    });

    // –ú–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    elements.categoryBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      elements.categoryMenu.classList.toggle('show');
      elements.settingsMenu.classList.remove('show');
      elements.moreMenu.classList.remove('show');
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –≤–∏–¥–∂–µ—Ç–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π
    elements.closeCategoryWidget.addEventListener('click', () => {
      elements.categoryMenu.classList.remove('show');
    });

    // –ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è
    elements.capitalizationBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      utils.toggleMenu(elements.capitalizationMenu);
    });

    elements.saveCapitalBtn.addEventListener('click', () => {
      const capitalVal = utils.parseInputValue(elements.capitalInput.value);
      if (!isNaN(capitalVal)) {
        dataService.setCapitalization(capitalVal);
        elements.capitalizationMenu.classList.remove('show');
        uiService.updateUI();
      }
    });

    elements.cancelCapitalBtn.addEventListener('click', () => {
      elements.capitalizationMenu.classList.remove('show');
    });

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏/–æ—Ç—á–µ—Ç—ã
    elements.settingsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      utils.toggleMenu(elements.settingsMenu);
    });

    elements.closeReportsBtn.addEventListener('click', () => {
      elements.settingsMenu.classList.remove('show');
    });

    // –ë—é–¥–∂–µ—Ç
    elements.budgetSettingsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      utils.toggleMenu(elements.setBudgetModal);
    });

    elements.saveBudgetBtn.addEventListener('click', () => {
      const amount = utils.parseInputValue(elements.budgetAmount.value);
      const days = parseInt(elements.budgetDays.value);
      
      if (!isNaN(amount) && !isNaN(days) && days > 0) {
        const today = new Date();
        state.budgetData = {
          totalAmount: amount,
          days: days,
          startDate: today.toISOString(),
          spent: 0,
          dailyHistory: {
            [today.toISOString().split('T')[0]]: {
              date: today.toISOString().split('T')[0],
              dailyBudget: amount / days,
              spentToday: 0
            }
          }
        };
        dataService.saveAllData();
        elements.setBudgetModal.classList.remove('show');
        uiService.updateBudgetWidget();
        
        utils.showSuccessMessage('–ë—é–¥–∂–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!');
      }
    });

    elements.cancelBudgetBtn.addEventListener('click', () => {
      elements.setBudgetModal.classList.remove('show');
    });

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –º–µ–Ω—é
    elements.moreBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      elements.moreMenu.classList.toggle('show');
      elements.settingsMenu.classList.remove('show');
      elements.categoryMenu.classList.remove('show');
    });

    // –í–∏–¥–∂–µ—Ç –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π
    elements.enableSavingsBtn.addEventListener('click', () => {
      elements.moreMenu.classList.remove('show');
      utils.toggleMenu(elements.savingsModal);
    });

    elements.saveSavingsBtn.addEventListener('click', () => {
      const name = elements.savingsName.value.trim();
      const goal = utils.parseInputValue(elements.savingsGoal.value);
      
      if (name && !isNaN(goal) && goal > 0) {
        state.savingsData = {
          enabled: true,
          name: name,
          goal: goal,
          current: state.savingsData.current || 0
        };
        dataService.saveAllData();
        elements.savingsModal.classList.remove('show');
        uiService.updateUI();
        
        utils.showSuccessMessage('–¶–µ–ª—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞!');
      }
    });

    elements.cancelSavingsBtn.addEventListener('click', () => {
      elements.savingsModal.classList.remove('show');
    });

    // –í–∏–¥–∂–µ—Ç —Ñ–æ–Ω–¥–∞
    elements.enableFundBtn.addEventListener('click', () => {
      elements.moreMenu.classList.remove('show');
      utils.toggleMenu(elements.fundModal);
    });

    elements.saveFundBtn.addEventListener('click', () => {
      const name = elements.fundName.value.trim();
      const total = utils.parseInputValue(elements.fundTotal.value);
      
      if (name && !isNaN(total) && total > 0) {
        state.fundData = {
          enabled: true,
          name: name,
          total: total,
          current: total // –§–æ–Ω–¥ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø–æ–ª–Ω–æ–π —Å—É–º–º—ã
        };
        dataService.saveAllData();
        elements.fundModal.classList.remove('show');
        uiService.updateUI();
        
        utils.showSuccessMessage('–§–æ–Ω–¥ —Å–æ–∑–¥–∞–Ω!');
      }
    });

    elements.cancelFundBtn.addEventListener('click', () => {
      elements.fundModal.classList.remove('show');
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–µ–≤
    elements.monthTabs.forEach(tab => {
      tab.addEventListener('click', () => {
        elements.monthTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        state.currentMonth = parseInt(tab.dataset.month);
        uiService.updateUI();
      });
    });

    // –í—ã–±–æ—Ä –≥–æ–¥–∞
    elements.yearSelectBtn.addEventListener('click', () => {
      elements.moreMenu.classList.remove('show');
      utils.toggleMenu(elements.yearSelectModal);
      uiService.renderYearSelection();
    });

    elements.addYearBtn.addEventListener('click', () => {
      const newYear = state.currentYear + 1;
      if (!state.financeData[newYear]) {
        dataService.initYearData(newYear);
        dataService.saveAllData();
        uiService.renderYearSelection();
        utils.showSuccessMessage(`–ì–æ–¥ ${newYear} –¥–æ–±–∞–≤–ª–µ–Ω!`);
      } else {
        utils.showSuccessMessage(`–ì–æ–¥ ${newYear} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!`);
      }
    });
    
    elements.closeYearSelect.addEventListener('click', () => {
      elements.yearSelectModal.classList.remove('show');
    });

    // –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞—Ç
    elements.historyBtn.addEventListener('click', () => {
      elements.moreMenu.classList.remove('show');
      utils.toggleMenu(elements.historyModal);
    });
    
    elements.closeHistory.addEventListener('click', () => {
      elements.historyModal.classList.remove('show');
    });

    // –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
    elements.achievementsBtn.addEventListener('click', () => {
      elements.moreMenu.classList.remove('show');
      utils.toggleMenu(elements.achievementsModal);
      uiService.renderAchievements();
    });
    
    elements.closeAchievements.addEventListener('click', () => {
      elements.achievementsModal.classList.remove('show');
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≤–≤–æ–¥–∞ –ø–æ Enter
    const enterHandlers = [
      { element: elements.incomeInput, handler: elements.addIncomeBtn },
      { element: elements.newCategoryInput, handler: elements.addCategoryBtn },
      { element: elements.capitalInput, handler: elements.saveCapitalBtn },
      { element: elements.budgetAmount, handler: elements.saveBudgetBtn },
      { element: elements.budgetDays, handler: elements.saveBudgetBtn },
      { element: elements.savingsName, handler: elements.saveSavingsBtn },
      { element: elements.savingsGoal, handler: elements.saveSavingsBtn },
      { element: elements.fundName, handler: elements.saveFundBtn },
      { element: elements.fundTotal, handler: elements.saveFundBtn }
    ];

    enterHandlers.forEach(item => {
      item.element.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          item.handler.click();
        }
      });
    });

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
    elements.themeToggleBtn.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      localStorage.setItem('darkTheme', document.body.classList.contains('dark'));
      
      const icon = elements.themeToggleBtn.querySelector('.theme-icon');
      icon.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è' : 'üåô';
      
      // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–µ–º—ã
      chartService.renderMainChart();
      chartService.renderCapitalChart();
      chartService.renderMiniCharts();
      if (elements.yearSummary.classList.contains('show')) {
        chartService.renderYearCharts();
      }
    });

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
    document.addEventListener('click', (e) => {
      const menus = [
        elements.categoryMenu,
        elements.capitalizationMenu,
        elements.settingsMenu,
        elements.setBudgetModal,
        elements.moreMenu,
        elements.savingsModal,
        elements.fundModal,
        elements.yearSelectModal,
        elements.historyModal,
        elements.achievementsModal
      ];
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª –ª–∏ –∫–ª–∏–∫ –≤–Ω–µ –º–µ–Ω—é
      const clickOutside = !menus.some(menu => menu.contains(e.target));
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é
      const isMenuButton = [
        elements.categoryBtn,
        elements.capitalizationBtn,
        elements.settingsBtn,
        elements.budgetSettingsBtn,
        elements.moreBtn,
        elements.enableSavingsBtn,
        elements.enableFundBtn,
        elements.yearSelectBtn,
        elements.historyBtn,
        elements.achievementsBtn
      ].some(button => button.contains(e.target));
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –º–µ–Ω—é, –µ—Å–ª–∏ –∫–ª–∏–∫ –±—ã–ª –≤–Ω–µ –º–µ–Ω—é –∏ –Ω–µ –ø–æ –∫–Ω–æ–ø–∫–µ –º–µ–Ω—é
      if (clickOutside && !isMenuButton) {
        menus.forEach(menu => menu.classList.remove('show'));
      }
    });

    // –ó–∞–ø—Ä–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
    document.addEventListener('gesturestart', function(e) {
      e.preventDefault();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
    window.addEventListener('orientationchange', function() {
      setTimeout(function() {
        chartService.renderMainChart();
        chartService.renderCapitalChart();
      }, 500);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
    const handleResize = utils.debounce(() => {
      chartService.renderMiniCharts();
      if (elements.yearSummary.classList.contains('show')) {
        chartService.renderYearCharts();
      }
    }, 250);
    
    window.addEventListener('resize', handleResize);
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  const initializeApp = () => {
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞
    elements.monthTabs[state.currentMonth].classList.add('active');
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±—é–¥–∂–µ—Ç–∞
    if (state.budgetData.startDate) {
      const today = new Date();
      const lastBudgetDate = new Date(state.budgetData.startDate);
      
      if (today.getDate() !== lastBudgetDate.getDate() || 
          today.getMonth() !== lastBudgetDate.getMonth() || 
          today.getFullYear() !== lastBudgetDate.getFullYear()) {
        uiService.updateBudgetWidget();
      }
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã
    if (localStorage.getItem('darkTheme') === 'true') {
      document.body.classList.add('dark');
      const icon = elements.themeToggleBtn.querySelector('.theme-icon');
      icon.textContent = '‚òÄÔ∏è';
    }
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
    setupEventHandlers();
    
    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
    uiService.updateUI();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è
    initTutorial();
  };

  // –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  initializeApp();
});
